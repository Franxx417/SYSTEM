document.addEventListener("DOMContentLoaded",function(){console.log("PO Edit script loaded");var s=document.getElementById("poEditForm");if(!s){console.log("Form element not found");return}console.log("Form element found:",s);var v=document.getElementById("items"),S=document.getElementById("itemRowTpl"),q=S?S.innerHTML:"",w=v&&v.children?v.children.length:0;const d=document.getElementById("supplier-select"),D=document.getElementById("manual-supplier-fields");function k(){const n=d?.options[d.selectedIndex],e=document.getElementById("supplier-vat"),a=n&&n.dataset&&n.dataset.vat?n.dataset.vat:"";if(e&&(e.textContent=a||"—"),d&&d.value==="__manual__"){D&&D.classList.remove("d-none");const t=document.getElementById("supplier-vat-type")?.value||"";e&&(e.textContent=t||"—"),[["supplier-name","new_supplier[name]"],["supplier-vat-type","new_supplier[vat_type]"],["supplier-address","new_supplier[address]"],["supplier-contact-person","new_supplier[contact_person]"],["supplier-contact-number","new_supplier[contact_number]"],["supplier-tin","new_supplier[tin_no]"]].forEach(([c,m])=>{const f=document.getElementById(c);f&&f.setAttribute("name",m)})}else D&&D.classList.add("d-none"),["supplier-name","supplier-vat-type","supplier-address","supplier-contact-person","supplier-contact-number","supplier-tin"].forEach(t=>{const o=document.getElementById(t);o&&o.removeAttribute("name")})}d&&(d.addEventListener("change",()=>{k(),u()}),k());const B=document.getElementById("supplier-vat-type");B&&B.addEventListener("change",function(){if(d&&d.value==="__manual__"){const n=document.getElementById("supplier-vat");n&&(n.textContent=this.value)}u()});function x(){const n=q.replaceAll("IDX",String(w++)),e=document.createElement("div");e.innerHTML=n;const a=e.firstElementChild;v&&v.appendChild(a),r(a),u()}var l=document.getElementById("addItem");l&&l.addEventListener("click",x),v&&v.addEventListener("click",function(n){var e=n.target;if(e&&e.classList&&e.classList.contains("removeItem")){var a=e.closest(".item-row");a&&a.remove(),u()}}),s&&s.addEventListener("submit",n=>{console.log("Form submit event triggered");const e=Array.from(document.querySelectorAll(".item-row"));console.log("Found rows:",e.length),e.length&&e.forEach((a,t)=>{const o=a.querySelector(".item-name-select"),c=a.querySelector(".item-name-manual"),m=a.querySelector(".item-desc-manual"),f=a.querySelector('input[name$="[quantity]"]'),y=a.querySelector(".unit-price");m&&(m.name=`items[${t}][item_description]`),f&&(f.name=`items[${t}][quantity]`),y&&(y.name=`items[${t}][unit_price]`);const E=c&&!c.classList.contains("d-none");console.log(`Row ${t}: manualVisible=${E}, nameSelect.value=${o?.value}, nameManual.value=${c?.value}`),E?(o&&o.removeAttribute("name"),c&&(c.name=`items[${t}][item_name]`),console.log(`Row ${t}: Set manual name to items[${t}][item_name]`)):(c&&c.removeAttribute("name"),o&&(o.name=`items[${t}][item_name]`),console.log(`Row ${t}: Set select name to items[${t}][item_name]`))})},!0);function i(){v&&Array.prototype.forEach.call(v.querySelectorAll(".item-row"),r)}function r(n){const e=n.querySelector(".item-name-select"),a=n.querySelector(".item-desc-manual"),t=n.querySelector(".unit-price"),o=n.querySelector(".item-name-manual");function c(){o&&(o.classList.remove("d-none"),o.name=e.name,o.focus()),e&&e.removeAttribute("name")}function m(){e&&!e.name&&(e.name=o&&o.name?o.name:"items[][item_name]"),o&&(o.name="",o.classList.add("d-none"))}e&&e.addEventListener("change",async()=>{if(!e.value){m(),a&&(a.value=""),t&&(t.value=""),u();return}if(e.value==="__manual__"){c(),a&&(a.value=""),t&&(t.value=""),u();return}m();const y=e.options[e.selectedIndex],E=y&&y.dataset?y.dataset.desc:"",_=y&&y.dataset?y.dataset.price:"";a&&(a.value=E||""),t&&_?t.value=parseFloat(_).toFixed(2):t&&(t.value=""),u()});const f=n.querySelector('input[name$="[quantity]"]');f&&f.addEventListener("input",u),t&&t.addEventListener("input",u)}function u(){let n=0;document.querySelectorAll(".item-row").forEach(b=>{const C=b.querySelector('input[name$="[quantity]"]'),N=b.querySelector(".unit-price"),P=parseFloat(C&&C.value||"0"),V=parseFloat(N&&N.value||"0");n+=P*V});const e=document.getElementById("calc-shipping-input"),a=document.getElementById("calc-discount-input"),t=e&&parseFloat((e.value||"0").replace(/[^0-9.]/g,""))||0,o=a&&parseFloat((a.value||"0").replace(/[^0-9.]/g,""))||0,c=Math.max(0,Math.round((n-o+t)*100)/100);let m="";if(d)if(d.value==="__manual__")m=document.getElementById("supplier-vat-type")?.value||"";else{const b=d.options[d.selectedIndex];m=b&&b.dataset&&b.dataset.vat?b.dataset.vat:""}let f=0;m&&m.toUpperCase()==="VAT"?f=Math.round(c*.12*100)/100:f=0;const y=Math.round((c+(m?f:0))*100)/100,E=document.getElementById("calc-subtotal"),_=document.getElementById("calc-vat"),T=document.getElementById("calc-total");m?(E&&(E.value=c.toFixed(2)),_&&(_.value=f.toFixed(2))):(E&&(E.value="0"),_&&(_.value="0")),T&&(T.textContent=y.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))}const p=document.getElementById("calc-shipping-input"),g=document.getElementById("calc-discount-input");p&&p.addEventListener("input",u),g&&g.addEventListener("input",u),i(),q&&v&&u();try{window.poEditWireRow=r,window.poEditRecalcTotals=u}catch{}const h="po_edit_draft_v1",I="po_edit_session_id";function L(){const n={supplier_id:d?d.value:"",new_supplier:{name:document.getElementById("supplier-name")?.value||"",vat_type:document.getElementById("supplier-vat-type")?.value||"",address:document.getElementById("supplier-address")?.value||"",contact_person:document.getElementById("supplier-contact-person")?.value||"",contact_number:document.getElementById("supplier-contact-number")?.value||"",tin_no:document.getElementById("supplier-tin")?.value||""},purpose:document.getElementById("purpose-input")?.value||"",date_requested:document.getElementById("date-from")?.value||"",delivery_date:document.getElementById("date-to")?.value||"",shipping:document.getElementById("calc-shipping-input")?.value||"",discount:document.getElementById("calc-discount-input")?.value||"",items:[]};return document.querySelectorAll("#items .item-row").forEach(e=>{const a=e.querySelector(".item-name-select"),t=e.querySelector(".item-name-manual"),c=t&&!t.classList.contains("d-none")?t.value||"":a?a.value:"";n.items.push({item_name:c,item_description:e.querySelector(".item-desc-manual")?.value||"",quantity:e.querySelector('input[name$="[quantity]"]')?.value||"",unit_price:e.querySelector(".unit-price")?.value||""})}),n}function A(n){try{if(!n)return;d&&n.supplier_id&&(d.value=n.supplier_id,d.dispatchEvent(new Event("change")));const e=n.new_supplier||{},a=(t,o)=>{const c=document.getElementById(t);c&&(c.value=o||"",c.dispatchEvent(new Event("input")))};a("supplier-name",e.name),a("supplier-vat-type",e.vat_type),a("supplier-address",e.address),a("supplier-contact-person",e.contact_person),a("supplier-contact-number",e.contact_number),a("supplier-tin",e.tin_no),a("purpose-input",n.purpose),a("date-from",n.date_requested),a("date-to",n.delivery_date),a("calc-shipping-input",n.shipping),a("calc-discount-input",n.discount),v&&(v.innerHTML="",w=0),(n.items||[]).forEach(t=>{x();const o=v.lastElementChild,c=o.querySelector(".item-name-select"),m=o.querySelector(".item-name-manual");c&&(t.item_name==="__manual__"||m&&t.item_name&&!Array.from(c.options).some(_=>_.value===t.item_name)?(c.value="__manual__",c.dispatchEvent(new Event("change")),m&&(m.value=t.item_name)):(c.value=t.item_name||"",c.dispatchEvent(new Event("change"))));const f=o.querySelector(".item-desc-manual");f&&(f.value=t.item_description||"",f.dispatchEvent(new Event("input")));const y=o.querySelector('input[name$="[quantity]"]');y&&(y.value=t.quantity||"",y.dispatchEvent(new Event("input")));const E=o.querySelector(".unit-price");E&&(E.value=t.unit_price||"",E.dispatchEvent(new Event("input")))}),u()}catch{}}function F(){try{localStorage.setItem(h,JSON.stringify(L())),localStorage.setItem(h+"_timestamp",Date.now().toString())}catch{}}function R(){try{const n=localStorage.getItem(h);return n?JSON.parse(n):null}catch{return null}}function M(){try{localStorage.removeItem(h),localStorage.removeItem(h+"_timestamp"),sessionStorage.removeItem(I)}catch{}}s&&(s.addEventListener("input",F),s.addEventListener("change",F),s.addEventListener("submit",()=>{M()}));try{window.poEditRestoreForm=A,window.poEditLoadDraft=R,window.poEditClearDraft=M,window.poEditSaveDraft=F}catch{}});typeof window<"u"&&window.jQuery&&jQuery(function(s){console.log("Initializing PO edit modal datepickers...");function v(){const l=s("#date-from"),i=s("#date-to");if(console.log("Found date inputs:",l.length,i.length),l.length&&i.length){l.hasClass("hasDatepicker")&&(console.log('Destroying existing "from" datepicker'),l.datepicker("destroy")),i.hasClass("hasDatepicker")&&(console.log('Destroying existing "to" datepicker'),i.datepicker("destroy"));try{l.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,showButtonPanel:!0,yearRange:"c-5:c+5",onSelect:function(r){console.log("From date selected:",r),i.datepicker("option","minDate",r),S()}}),i.datepicker({dateFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,showButtonPanel:!0,yearRange:"c-5:c+5",onSelect:function(r){console.log("To date selected:",r),l.datepicker("option","maxDate",r),S()}}),console.log("Datepickers initialized successfully!")}catch(r){console.error("Error initializing datepickers:",r),q(l,i)}}else console.warn("Date input elements not found")}function S(){const l=s("#date-from"),i=s("#date-to"),r=l.val(),u=i.val(),p=s("#result");if(r&&u){const g=new Date(r),h=new Date(u),I=Math.abs(h-g),L=Math.ceil(I/(1e3*60*60*24));p.text(`Delivery period: ${L} days`)}else p.text("")}function q(l,i){console.log("Adding manual date validation as fallback..."),l.on("blur",function(){r(s(this))}),i.on("blur",function(){r(s(this)),u(l,i)}),l.on("input",function(){u(l,i)});function r(p){const g=p.val();if(g)if(!/^\d{4}-\d{2}-\d{2}$/.test(g))p.addClass("is-invalid"),p.next(".invalid-feedback").length||p.after('<div class="invalid-feedback">Please use YYYY-MM-DD format</div>');else{const I=new Date(g);isNaN(I.getTime())?(p.addClass("is-invalid"),p.next(".invalid-feedback").length||p.after('<div class="invalid-feedback">Please enter a valid date</div>')):(p.removeClass("is-invalid"),p.next(".invalid-feedback").remove())}}function u(p,g){const h=new Date(p.val()),I=new Date(g.val());!isNaN(h.getTime())&&!isNaN(I.getTime())&&(h>I?(g.addClass("is-invalid"),g.next(".invalid-feedback").length||g.after('<div class="invalid-feedback">Delivery date must be after request date</div>')):(g.removeClass("is-invalid"),g.next(".invalid-feedback").remove(),S()))}}s("#editPOModal").on("shown.bs.modal",function(){console.log("Edit modal shown, initializing datepickers..."),setTimeout(function(){v()},100)}),s("#editPOModal").on("hidden.bs.modal",function(){console.log("Edit modal hidden, cleaning up datepickers...");const l=s("#date-from"),i=s("#date-to");try{l.hasClass("hasDatepicker")&&(console.log('Destroying "from" datepicker'),l.datepicker("destroy")),i.hasClass("hasDatepicker")&&(console.log('Destroying "to" datepicker'),i.datepicker("destroy"))}catch(r){console.error("Error destroying datepickers:",r)}}),s(document).ready(function(){console.log("Document ready, checking for jQuery UI availability..."),typeof s.datepicker<"u"?(console.log("jQuery UI datepicker is available"),s("#editPOModal").length||v()):console.error("jQuery UI datepicker is not available")});const w=s("#purpose-input"),d=s("#text-count"),D=w.attr("maxlength");if(w.length&&d.length&&D){let l=function(){const i=D-w.val().length;d.text(i+" characters remaining"),d.toggleClass("text-danger",i<=20).toggleClass("text-muted",i>20)};var x=l;l(),w.on("input",l)}function k(){const l=s(this);let i=l.val().replace(/[^0-9.]/g,"");const r=i.split(".");r.length>2&&(i=r[0]+"."+r.slice(1).join(""));const u=parseFloat(i);(u<0||isNaN(u))&&(i="0.00"),l.val(i)}function B(){const l=s(this),i=parseFloat(l.val());l.val(isNaN(i)?"0.00":i.toFixed(2))}s("#calc-shipping-input, #calc-discount-input").on("input",k).on("blur",B),window.updateDateInfo=S});
