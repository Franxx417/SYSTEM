document.addEventListener("DOMContentLoaded",function(){var m=document.getElementById("po-index-table");if(!m)return;var f=m.getAttribute("data-po-show-template");if(!f)return;m.addEventListener("click",async function(a){var e=a.target&&a.target.closest(".btn-view-po");if(e){var n=e.getAttribute("data-po"),t=f.replace("__po__",n);try{var o=await fetch(t);if(!o.ok)return;var d=await o.json();B(d),window.bootstrap&&document.getElementById("poModal")&&new bootstrap.Modal(document.getElementById("poModal")).show()}catch{}}}),window.editPO=function(e,n,t,o,d){var u=document.getElementById("editPOForm");u&&(u.action="/po/"+e);var r;r=document.getElementById("edit_purpose"),r&&(r.value=n||""),r=document.getElementById("edit_supplier_id"),r&&(r.value=t||""),r=document.getElementById("edit_date_requested"),r&&(r.value=o||""),r=document.getElementById("edit_delivery_date"),r&&(r.value=d||""),window.bootstrap&&document.getElementById("editPOModal")&&new bootstrap.Modal(document.getElementById("editPOModal")).show()},window.deletePO=function(e,n){var t=document.getElementById("deletePOForm");t&&(t.action="/po/"+e);var o;o=document.getElementById("delete_po_number"),o&&(o.textContent=e||""),o=document.getElementById("delete_po_purpose"),o&&(o.textContent=n||""),window.bootstrap&&document.getElementById("deletePOModal")&&new bootstrap.Modal(document.getElementById("deletePOModal")).show()};var h=document.querySelectorAll(".status-dropdown");h.forEach(function(a){a.dataset.originalValue=a.value,b(a),a.addEventListener("change",function(e){e.preventDefault(),e.stopPropagation();var n=this,t=n.closest("form");if(t){t.addEventListener("submit",function(l){window.__allowStatusSubmit||(l.preventDefault(),l.stopPropagation())},{once:!0,capture:!0});var o=n.dataset.po||t.action.split("/").pop(),d=n.getAttribute("data-current-status")||(function(){var l=n.options[n.selectedIndex];return l?l.textContent:""})(),u=n.options[n.selectedIndex].textContent,r=n.value;window.pendingStatusForm=t,window.pendingStatusValue=r,window.pendingStatusSelect=n,window.pendingStatusOldValue=n.dataset.originalValue||n.value;var i;if(i=document.getElementById("status_po_number"),i&&(i.textContent=o),i=document.getElementById("status_from"),i&&(i.textContent=d),i=document.getElementById("status_to"),i&&(i.textContent=u),i=document.getElementById("status_remarks"),i&&(i.value=""),window.bootstrap&&document.getElementById("statusChangeModal")){var p=new bootstrap.Modal(document.getElementById("statusChangeModal"));p.show()}n.value=n.dataset.originalValue}})});function b(a){var e=a.options[a.selectedIndex].textContent,n=a.closest(".d-flex")?.querySelector(".status-indicator");if(n)switch(n.classList.remove("status-warning","status-info","status-online","status-success","status-offline"),e){case"Pending":n.classList.add("status-warning");break;case"Verified":n.classList.add("status-info");break;case"Approved":n.classList.add("status-online");break;case"Received":n.classList.add("status-success");break;case"Rejected":n.classList.add("status-offline");break}}var v=document.getElementById("confirmStatusChange");v&&v.addEventListener("click",function(){if(window.pendingStatusForm&&window.pendingStatusValue){var a=window.pendingStatusForm,e=window.pendingStatusSelect,n=window.pendingStatusValue,t=document.getElementById("status_remarks"),o=t?t.value:"",d=a.querySelector('input[name="_token"]'),u=d?d.value:"",r=new FormData(a);r.set("status_id",n),r.set("remarks",o||"Status changed via dropdown"),fetch(a.action,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":u},body:r,credentials:"same-origin"}).then(function(i){if(!i.ok)throw new Error("Failed to update status");return i.json().catch(function(){return{}})}).then(function(){if(e){e.value=n,e.dataset.originalValue=n;var i=e.options[e.selectedIndex];i&&e.setAttribute("data-current-status",i.textContent)}}).catch(function(i){console.error(i),alert("Could not update status. Please try again.")}).finally(function(){var i=bootstrap.Modal.getInstance(document.getElementById("statusChangeModal"));i&&i.hide(),window.pendingStatusForm=null,window.pendingStatusValue=null,window.pendingStatusSelect=null,window.pendingStatusOldValue=null})}});function B(a){var e=a&&a.po||{},n=a&&a.items||[],t;t=document.getElementById("poModalLabel"),t&&(t.textContent="PO #"+(e.purchase_order_no||"")),t=document.getElementById("poModalSupplier"),t&&(t.textContent=e.supplier_name||""),t=document.getElementById("poModalStatus"),t&&(t.textContent=e.status_name||""),t=document.getElementById("poModalPurpose"),t&&(t.textContent=e.purpose||""),t=document.getElementById("poModalTotals"),t&&(t.textContent="₱"+Number(e.total||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}));var o=document.getElementById("poModalItems");o&&(o.innerHTML="",n.forEach(function(d){var u=document.createElement("tr");u.innerHTML="<td>"+(d.item_name||d.item_description||"")+'</td><td class="text-end">'+(d.quantity||0)+'</td><td class="text-end">₱'+Number(d.unit_price||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})+'</td><td class="text-end">₱'+Number(d.total_cost||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})+"</td>",o.appendChild(u)}))}function S(a){var e=a&&a.po||{},n=a&&a.items||[],t;t=document.getElementById("edit-po-number"),t&&(t.value=e.purchase_order_no||""),t=document.getElementById("purpose-input"),t&&(t.value=e.purpose||""),t=document.getElementById("date-from"),t&&(t.value=e.date_requested||""),t=document.getElementById("date-to"),t&&(t.value=e.delivery_date||"");var o=document.getElementById("supplier-select");o&&e.supplier_id&&(o.value=e.supplier_id,o.dispatchEvent(new Event("change"))),t=document.getElementById("calc-shipping-input"),t&&(t.value=Number(e.shipping_fee||0).toFixed(2)),t=document.getElementById("calc-discount-input"),t&&(t.value=Number(e.discount||0).toFixed(2)),t=document.getElementById("calc-subtotal"),t&&(t.value=Number(e.subtotal||0).toFixed(2)),t=document.getElementById("calc-vat"),t&&(t.value=Number((e.total||0)-(e.subtotal||0)).toFixed(2)),t=document.getElementById("calc-total"),t&&(t.textContent=Number(e.total||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}));var d=document.getElementById("items");d&&(d.innerHTML="",n.forEach(function(u,r){var i=document.getElementById("itemRowTpl");if(i){var p=i.innerHTML.replaceAll("IDX",String(r)),l=document.createElement("div");l.innerHTML=p;var s=l.firstElementChild;d.appendChild(s);var c=s.querySelector(".item-name-select"),g=s.querySelector(".item-name-manual"),w=s.querySelector(".item-desc-manual"),E=s.querySelector('input[name$="[quantity]"]'),y=s.querySelector(".unit-price");if(c&&u.item_name){var _=!1;Array.from(c.options).forEach(function(I){I.value===u.item_name&&(I.selected=!0,_=!0)}),_||(c.value="__manual__",c.dispatchEvent(new Event("change")),g&&(g.value=u.item_name))}w&&(w.value=u.item_description||""),E&&(E.value=u.quantity||""),y&&(y.value=Number(u.unit_price||0).toFixed(2)),window.poEditWireRow&&window.poEditWireRow(s)}}),window.poEditRecalcTotals&&window.poEditRecalcTotals())}window.showEditModal=function(a){try{var e=document.getElementById("po-index-table"),n=e?e.getAttribute("data-po-show-template"):null,t=n?n.replace("__po__",a):"/po/"+a+"/data";fetch(t).then(o=>o.json()).then(o=>{S(o);var d=document.getElementById("poEditForm");d&&(d.action="/po/"+a);var u=new bootstrap.Modal(document.getElementById("editPOModal"));u.show()}).catch(o=>{console.error("Error loading PO data:",o),alert("Error loading purchase order data")})}catch(o){console.error(o),alert("Could not open edit modal.")}};var x=document.querySelectorAll(".alert");x.forEach(function(a){setTimeout(function(){var e=new bootstrap.Alert(a);e.close()},5e3)})});
