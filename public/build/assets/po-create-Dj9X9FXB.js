document.addEventListener("DOMContentLoaded",()=>{const c=document.getElementById("poForm");if(!c)return;const s=document.getElementById("items"),d=document.getElementById("itemRowTpl"),l=d?d.innerHTML:"";let p=0;fetch(c.dataset.nextNumberUrl||"/po/next/number").then(e=>e.ok?e.json():{}).then(e=>{const t=document.getElementById("po-number");t&&e.po_no&&(t.value=e.po_no)}).catch(()=>{});const u=document.getElementById("supplier-select");function v(){const e=u?.options[u.selectedIndex],t=document.getElementById("supplier-vat");t&&(t.textContent=e&&e.dataset&&e.dataset.vat?e.dataset.vat:"â€”")}u&&(u.addEventListener("change",v),v());function h(){const e=l.replaceAll("IDX",String(p++)),t=document.createElement("div");t.innerHTML=e;const o=t.firstElementChild;s.appendChild(o),i(o),n()}const L=document.getElementById("addItem");L&&L.addEventListener("click",h),s&&s.addEventListener("click",e=>{const t=e.target;if(t&&t.classList&&t.classList.contains("removeItem")){const o=t.closest(".item-row");o&&o.remove(),n()}});function i(e){const t=e.querySelector(".item-desc-select"),o=e.querySelector(".item-desc-manual"),a=e.querySelector(".unit-price");function x(){o.classList.remove("d-none"),o.name=t.name,t.removeAttribute("name"),o.focus()}function y(){t.name||(t.name=o.name||"items[][item_description]"),o.name="",o.classList.add("d-none")}t.addEventListener("change",async()=>{if(!t.value){y(),a&&(a.value="");return}if(t.value==="__manual__"){x(),a&&(a.value="");return}y();try{const g=new URL(c.dataset.latestPriceUrl||"/api/items/latest-price",window.location.origin);g.searchParams.set("description",t.value);const m=await fetch(g.toString()).then(I=>I.json());m.price!==null&&m.price!==void 0&&a?(a.value=parseFloat(m.price).toFixed(2),n()):a&&(a.value="")}catch{a&&(a.value="")}});const E=e.querySelector('input[name$="[quantity]"]');E&&E.addEventListener("input",n),a&&a.addEventListener("input",n)}function n(){let e=0;document.querySelectorAll(".item-row").forEach(w=>{const B=w.querySelector('input[name$="[quantity]"]'),S=w.querySelector(".unit-price"),F=parseFloat(B&&B.value||"0"),q=parseFloat(S&&S.value||"0");e+=F*q});const t=document.getElementById("calc-shipping-input"),o=document.getElementById("calc-discount-input"),a=t&&parseFloat((t.value||"0").replace(/[^0-9.]/g,""))||0,x=o&&parseFloat((o.value||"0").replace(/[^0-9.]/g,""))||0,y=Math.max(0,Math.round((e-x+a)*100)/100),E=Math.round(y*100)/100,g=document.getElementById("calc-subtotal"),m=document.getElementById("calc-vat"),I=document.getElementById("calc-total");g&&(g.value=""),m&&(m.value=""),I&&(I.textContent=E.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))}const r=document.getElementById("calc-shipping-input"),f=document.getElementById("calc-discount-input");r&&r.addEventListener("input",n),f&&f.addEventListener("input",n),l&&s&&(h(),n())});typeof window<"u"&&window.jQuery&&jQuery(function(c){const s=c("#date-from"),d=c("#date-to");s.length&&d.length&&(s.datepicker({dateFormat:"yy-mm-dd",onSelect:i=>d.datepicker("option","minDate",i)}),d.datepicker({dateFormat:"yy-mm-dd",onSelect:i=>s.datepicker("option","maxDate",i)}));const l=c("#purpose-input"),p=c("#text-count"),u=l.attr("maxlength");if(l.length&&p.length&&u){let i=function(){const n=u-l.val().length;p.text(n+" characters remaining"),p.toggleClass("text-danger",n<=20).toggleClass("text-muted",n>20)};var L=i;i(),l.on("input",i)}function v(){const i=c(this);let n=i.val().replace(/[^0-9.]/g,"");const r=n.split(".");r.length>2&&(n=r[0]+"."+r.slice(1).join(""));const f=parseFloat(n);(f<0||isNaN(f))&&(n="0.00"),i.val(n)}function h(){const i=c(this),n=parseFloat(i.val());i.val(isNaN(n)?"0.00":n.toFixed(2))}c("#calc-shipping-input, #calc-discount-input, #calc-vat-input, #calc-subtotal-input").on("input",v).on("blur",h)});
