document.addEventListener("DOMContentLoaded",function(){if(console.log("PO Edit Modal script loaded"),!document.getElementById("editPOModal")){console.log("Edit modal not found");return}const g=document.getElementById("poEditForm"),u=document.getElementById("items"),E=document.getElementById("itemRowTpl"),x=E?E.innerHTML:"";let F=u&&u.children?u.children.length:0;const o=document.getElementById("supplier-select"),v=document.getElementById("manual-supplier-fields");function I(){!o||!v||(o.value==="__manual__"?v.classList.remove("d-none"):v.classList.add("d-none"))}function S(){if(!o)return;const n=document.getElementById("supplier-vat");if(n){if(o.value==="__manual__"){const e=document.getElementById("supplier-vat-type");n.textContent=e?e.value:"—"}else if(o.value){const e=o.options[o.selectedIndex];n.textContent=e&&e.dataset&&e.dataset.vat?e.dataset.vat:"—"}else n.textContent="—";l()}}o&&(o.addEventListener("change",function(){I(),S()}),I(),S());const _=document.getElementById("supplier-vat-type");_&&_.addEventListener("change",function(){if(o&&o.value==="__manual__"){const n=document.getElementById("supplier-vat");n&&(n.textContent=this.value)}l()});function M(){const n=x.replaceAll("IDX",String(F++)),e=document.createElement("div");e.innerHTML=n;const a=e.firstElementChild;u&&u.appendChild(a),y(a),l()}const h=document.getElementById("addItem");h&&h.addEventListener("click",M),u&&u.addEventListener("click",function(n){const e=n.target;if(e&&e.classList&&e.classList.contains("removeItem")){const a=e.closest(".item-row");a&&a.remove(),l()}}),g&&g.addEventListener("submit",n=>{console.log("Form submit event triggered");const e=Array.from(document.querySelectorAll(".item-row"));console.log("Found rows:",e.length),e.length&&e.forEach((a,t)=>{const i=a.querySelector(".item-name-select"),c=a.querySelector(".item-name-manual"),s=a.querySelector(".item-desc-manual"),m=a.querySelector('input[name$="[quantity]"]'),d=a.querySelector(".unit-price");s&&(s.name=`items[${t}][item_description]`),m&&(m.name=`items[${t}][quantity]`),d&&(d.name=`items[${t}][unit_price]`);const r=c&&!c.classList.contains("d-none");console.log(`Row ${t}: manualVisible=${r}, nameSelect.value=${i?.value}, nameManual.value=${c?.value}`),r?(i&&i.removeAttribute("name"),c&&(c.name=`items[${t}][item_name]`),console.log(`Row ${t}: Set manual name to items[${t}][item_name]`)):(c&&c.removeAttribute("name"),i&&(i.name=`items[${t}][item_name]`),console.log(`Row ${t}: Set select name to items[${t}][item_name]`))})},!0);function b(){u&&Array.prototype.forEach.call(u.querySelectorAll(".item-row"),y)}function y(n){const e=n.querySelector(".item-name-select"),a=n.querySelector(".item-desc-manual"),t=n.querySelector(".unit-price"),i=n.querySelector(".item-name-manual");function c(){i&&(i.classList.remove("d-none"),i.name=e.name,i.focus()),e&&e.removeAttribute("name")}function s(){e&&!e.name&&(e.name=i&&i.name?i.name:"items[][item_name]"),i&&(i.name="",i.classList.add("d-none"))}e&&e.addEventListener("change",async()=>{if(!e.value){s(),a&&(a.value=""),t&&(t.value=""),l();return}if(e.value==="__manual__"){c(),a&&(a.value=""),t&&(t.value=""),l();return}s();const d=e.options[e.selectedIndex],r=d&&d.dataset?d.dataset.desc:"",p=d&&d.dataset?d.dataset.price:"";a&&(a.value=r||""),t&&p?t.value=parseFloat(p).toFixed(2):t&&(t.value=""),l()});const m=n.querySelector('input[name$="[quantity]"]');m&&m.addEventListener("input",l),t&&t.addEventListener("input",l)}function l(){let n=0;if(!u)return;Array.prototype.forEach.call(u.querySelectorAll(".item-row"),function(f){const $=f.querySelector('input[name$="[quantity]"]'),w=f.querySelector(".unit-price"),A=$&&parseFloat($.value)||0,T=w&&parseFloat(w.value)||0;n+=A*T});const e=document.getElementById("calc-shipping-input"),a=document.getElementById("calc-discount-input"),t=e&&parseFloat((e.value||"0").replace(/[^0-9.]/g,""))||0,i=a&&parseFloat((a.value||"0").replace(/[^0-9.]/g,""))||0,c=Math.max(0,Math.round((n-i+t)*100)/100);let s="";if(o)if(o.value==="__manual__")s=document.getElementById("supplier-vat-type")?.value||"";else{const f=o.options[o.selectedIndex];s=f&&f.dataset&&f.dataset.vat?f.dataset.vat:""}let m=0;s&&s.toUpperCase()==="VAT"?m=Math.round(c*.12*100)/100:m=0;const d=Math.round((c+(s?m:0))*100)/100,r=document.getElementById("calc-subtotal"),p=document.getElementById("calc-vat"),B=document.getElementById("calc-total");s?(r&&(r.value=c.toFixed(2)),p&&(p.value=m.toFixed(2))):(r&&(r.value="0"),p&&(p.value="0")),B&&(B.textContent=d.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))}const q=document.getElementById("calc-shipping-input"),L=document.getElementById("calc-discount-input");q&&q.addEventListener("input",l),L&&L.addEventListener("input",l),b(),l(),window.poEditWireRow=y,window.poEditRecalcTotals=l});
