document.addEventListener("DOMContentLoaded",()=>{console.log("PO Create script loaded");const r=document.getElementById("poForm");if(!r){console.log("Form element not found");return}console.log("Form element found:",r);const m=document.getElementById("items"),v=document.getElementById("itemRowTpl"),f=v?v.innerHTML:"";let E=0;fetch(r.dataset.nextNumberUrl||"/po/next/number").then(t=>t.ok?t.json():{}).then(t=>{const e=document.getElementById("po-number");e&&t.po_no&&(e.value=t.po_no)}).catch(()=>{});const l=document.getElementById("supplier-select"),h=document.getElementById("manual-supplier-fields");function q(){const t=l?.options[l.selectedIndex],e=document.getElementById("supplier-vat"),a=t&&t.dataset&&t.dataset.vat?t.dataset.vat:"";if(e&&(e.textContent=a||"—"),l&&l.value==="__manual__"){h&&h.classList.remove("d-none");const n=document.getElementById("supplier-vat-type")?.value||"";e&&(e.textContent=n||"—"),[["supplier-name","new_supplier[name]"],["supplier-vat-type","new_supplier[vat_type]"],["supplier-address","new_supplier[address]"],["supplier-contact-person","new_supplier[contact_person]"],["supplier-contact-number","new_supplier[contact_number]"],["supplier-tin","new_supplier[tin_no]"]].forEach(([s,o])=>{const c=document.getElementById(s);c&&c.setAttribute("name",o)})}else h&&h.classList.add("d-none"),["supplier-name","supplier-vat-type","supplier-address","supplier-contact-person","supplier-contact-number","supplier-tin"].forEach(n=>{const i=document.getElementById(n);i&&i.removeAttribute("name")})}l&&(l.addEventListener("change",()=>{q(),p()}),q());const B=document.getElementById("supplier-vat-type");B&&B.addEventListener("change",function(){if(l&&l.value==="__manual__"){const t=document.getElementById("supplier-vat");t&&(t.textContent=this.value)}p()});function S(){const t=f.replaceAll("IDX",String(E++)),e=document.createElement("div");e.innerHTML=t;const a=e.firstElementChild;m&&m.appendChild(a),T(a),p()}const w=document.getElementById("addItem");w&&w.addEventListener("click",S),m&&m.addEventListener("click",t=>{const e=t.target;if(e&&e.classList&&e.classList.contains("removeItem")){const a=e.closest(".item-row");a&&a.remove(),p()}}),r&&r.addEventListener("submit",t=>{console.log("Form submit event triggered");const e=Array.from(document.querySelectorAll(".item-row"));console.log("Found rows:",e.length),e.length&&e.forEach((a,n)=>{const i=a.querySelector(".item-name-select"),s=a.querySelector(".item-name-manual"),o=a.querySelector(".item-desc-manual"),c=a.querySelector('input[name$="[quantity]"]'),u=a.querySelector(".unit-price");o&&(o.name=`items[${n}][item_description]`),c&&(c.name=`items[${n}][quantity]`),u&&(u.name=`items[${n}][unit_price]`);const d=s&&!s.classList.contains("d-none");console.log(`Row ${n}: manualVisible=${d}, nameSelect.value=${i?.value}, nameManual.value=${s?.value}`),d?(i&&i.removeAttribute("name"),s&&(s.name=`items[${n}][item_name]`),console.log(`Row ${n}: Set manual name to items[${n}][item_name]`)):(s&&s.removeAttribute("name"),i&&(i.name=`items[${n}][item_name]`),console.log(`Row ${n}: Set select name to items[${n}][item_name]`))})},!0);function T(t){const e=t.querySelector(".item-name-select"),a=t.querySelector(".item-desc-manual"),n=t.querySelector(".unit-price"),i=t.querySelector(".item-name-manual");function s(){i&&(i.classList.remove("d-none"),i.name=e.name,i.focus()),e&&e.removeAttribute("name")}function o(){e&&!e.name&&(e.name=i&&i.name?i.name:"items[][item_name]"),i&&(i.name="",i.classList.add("d-none"))}e&&e.addEventListener("change",async()=>{if(!e.value){o(),a&&(a.value=""),n&&(n.value=""),p();return}if(e.value==="__manual__"){s(),a&&(a.value=""),n&&(n.value=""),p();return}o();const u=e.options[e.selectedIndex],d=u&&u.dataset?u.dataset.desc:"",y=u&&u.dataset?u.dataset.price:"";a&&(a.value=d||""),n&&y?n.value=parseFloat(y).toFixed(2):n&&(n.value=""),p()});const c=t.querySelector('input[name$="[quantity]"]');c&&c.addEventListener("input",p),n&&n.addEventListener("input",p)}function p(){let t=0;document.querySelectorAll(".item-row").forEach(g=>{const M=g.querySelector('input[name$="[quantity]"]'),A=g.querySelector(".unit-price"),O=parseFloat(M&&M.value||"0"),k=parseFloat(A&&A.value||"0");t+=O*k});const e=document.getElementById("calc-shipping-input"),a=document.getElementById("calc-discount-input"),n=e&&parseFloat((e.value||"0").replace(/[^0-9.]/g,""))||0,i=a&&parseFloat((a.value||"0").replace(/[^0-9.]/g,""))||0,s=Math.max(0,Math.round((t-i+n)*100)/100);let o="";if(l)if(l.value==="__manual__")o=document.getElementById("supplier-vat-type")?.value||"";else{const g=l.options[l.selectedIndex];o=g&&g.dataset&&g.dataset.vat?g.dataset.vat:""}let c=0;o&&o.toUpperCase()==="VAT"?c=Math.round(s*.12*100)/100:c=0;const u=Math.round((s+(o?c:0))*100)/100,d=document.getElementById("calc-subtotal"),y=document.getElementById("calc-vat"),x=document.getElementById("calc-total");o?(d&&(d.value=s.toFixed(2)),y&&(y.value=c.toFixed(2))):(d&&(d.value="0"),y&&(y.value="0")),x&&(x.textContent=u.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))}const L=document.getElementById("calc-shipping-input"),b=document.getElementById("calc-discount-input");L&&L.addEventListener("input",p),b&&b.addEventListener("input",p);const _="po_create_draft_v1",I="po_create_session_id";function D(){return Date.now()+"_"+Math.random().toString(36).substr(2,9)}function N(){const t=new URLSearchParams(window.location.search),e=sessionStorage.getItem(I);if(t.has("new")||!e)return!0;const a=document.referrer,n=window.location.pathname;return!!(a&&!a.includes(n))}function C(){const t={supplier_id:l?l.value:"",new_supplier:{name:document.getElementById("supplier-name")?.value||"",vat_type:document.getElementById("supplier-vat-type")?.value||"",address:document.getElementById("supplier-address")?.value||"",contact_person:document.getElementById("supplier-contact-person")?.value||"",contact_number:document.getElementById("supplier-contact-number")?.value||"",tin_no:document.getElementById("supplier-tin")?.value||""},purpose:document.getElementById("purpose-input")?.value||"",date_requested:document.getElementById("date-from")?.value||"",delivery_date:document.getElementById("date-to")?.value||"",shipping:document.getElementById("calc-shipping-input")?.value||"",discount:document.getElementById("calc-discount-input")?.value||"",items:[]};return document.querySelectorAll("#items .item-row").forEach(e=>{const a=e.querySelector(".item-name-select"),n=e.querySelector(".item-name-manual"),s=n&&!n.classList.contains("d-none")?n.value||"":a?a.value:"";t.items.push({item_name:s,item_description:e.querySelector(".item-desc-manual")?.value||"",quantity:e.querySelector('input[name$="[quantity]"]')?.value||"",unit_price:e.querySelector(".unit-price")?.value||""})}),t}function P(t){try{if(!t)return;l&&t.supplier_id&&(l.value=t.supplier_id,l.dispatchEvent(new Event("change")));const e=t.new_supplier||{},a=(n,i)=>{const s=document.getElementById(n);s&&(s.value=i||"",s.dispatchEvent(new Event("input")))};a("supplier-name",e.name),a("supplier-vat-type",e.vat_type),a("supplier-address",e.address),a("supplier-contact-person",e.contact_person),a("supplier-contact-number",e.contact_number),a("supplier-tin",e.tin_no),a("purpose-input",t.purpose),a("date-from",t.date_requested),a("date-to",t.delivery_date),a("calc-shipping-input",t.shipping),a("calc-discount-input",t.discount),m&&(m.innerHTML="",E=0),(t.items||[]).forEach(n=>{S();const i=m.lastElementChild,s=i.querySelector(".item-name-select"),o=i.querySelector(".item-name-manual");s&&(n.item_name==="__manual__"||o&&n.item_name&&!Array.from(s.options).some(y=>y.value===n.item_name)?(s.value="__manual__",s.dispatchEvent(new Event("change")),o&&(o.value=n.item_name)):(s.value=n.item_name||"",s.dispatchEvent(new Event("change"))));const c=i.querySelector(".item-desc-manual");c&&(c.value=n.item_description||"",c.dispatchEvent(new Event("input")));const u=i.querySelector('input[name$="[quantity]"]');u&&(u.value=n.quantity||"",u.dispatchEvent(new Event("input")));const d=i.querySelector(".unit-price");d&&(d.value=n.unit_price||"",d.dispatchEvent(new Event("input")))}),p()}catch{}}function F(){try{localStorage.setItem(_,JSON.stringify(C())),localStorage.setItem(_+"_timestamp",Date.now().toString())}catch{}}function R(){try{const t=localStorage.getItem(_);return t?JSON.parse(t):null}catch{return null}}function $(){try{localStorage.removeItem(_),localStorage.removeItem(_+"_timestamp"),sessionStorage.removeItem(I)}catch{}}function V(){if(N())$(),sessionStorage.setItem(I,D()),console.log("Fresh form creation - starting with empty form"),f&&m&&(S(),p());else{const t=R();t?(console.log("Page refresh detected - restoring form data"),P(t)):f&&m&&(S(),p())}}r.addEventListener("input",F),r.addEventListener("change",F),V(),r.addEventListener("submit",()=>{$()})});function H(r){r.addEventListener("input",function(m){let v=this.value;v=v.replace(/[^0-9.]/g,"");const f=v.split(".");f.length>2&&(v=f[0]+"."+f.slice(1).join(""));const E=parseFloat(v);(E<0||isNaN(E))&&(v=""),this.value=v}),r.addEventListener("blur",function(){if(this.value===""||this.value===".")this.value="0.00";else{const m=parseFloat(this.value);this.value=isNaN(m)?"0.00":m.toFixed(2)}}),r.addEventListener("paste",function(m){setTimeout(()=>{let v=this.value.replace(/[^0-9.]/g,"");const f=parseFloat(v);(f<0||isNaN(f))&&(this.value="0.00")},0)})}document.querySelectorAll(".number-only-input:not([readonly])").forEach(r=>{H(r)});
