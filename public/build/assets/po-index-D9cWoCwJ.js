import"./po-print-direct-CuFG6l5q.js";document.addEventListener("DOMContentLoaded",function(){var m=document.getElementById("po-index-table");if(!m)return;var f=m.getAttribute("data-po-show-template");if(!f)return;m.addEventListener("click",function(o){var t=o.target&&o.target.closest(".btn-view-po");if(t){var e=t.getAttribute("data-po");L(e),o.stopPropagation(),o.preventDefault()}}),window.editPO=function(t,e,a,n,l){var d=document.getElementById("editPOForm");d&&(d.action="/po/"+t);var s;s=document.getElementById("edit_purpose"),s&&(s.value=e||""),s=document.getElementById("edit_supplier_id"),s&&(s.value=a||""),s=document.getElementById("edit_date_requested"),s&&(s.value=n||""),s=document.getElementById("edit_delivery_date"),s&&(s.value=l||""),window.bootstrap&&document.getElementById("editPOModal")&&new bootstrap.Modal(document.getElementById("editPOModal")).show()},window.deletePO=function(t,e){var a=document.getElementById("deletePOForm");a&&(a.action="/po/"+t);var n;n=document.getElementById("delete_po_number"),n&&(n.textContent=t||""),n=document.getElementById("delete_po_purpose"),n&&(n.textContent=e||""),window.bootstrap&&document.getElementById("deletePOModal")&&new bootstrap.Modal(document.getElementById("deletePOModal")).show()};var v=document.querySelectorAll(".status-dropdown");v.forEach(function(o){o.dataset.originalValue=o.value,E(o),o.addEventListener("change",function(t){t.preventDefault(),t.stopPropagation();var e=this,a=e.closest("form");if(a){a.addEventListener("submit",function(u){window.__allowStatusSubmit||(u.preventDefault(),u.stopPropagation())},{once:!0,capture:!0});var n=e.dataset.po||a.action.split("/").pop(),l=e.getAttribute("data-current-status")||(function(){var u=e.options[e.selectedIndex];return u?u.textContent:""})(),d=e.options[e.selectedIndex].textContent,s=e.value;window.pendingStatusForm=a,window.pendingStatusValue=s,window.pendingStatusSelect=e,window.pendingStatusOldValue=e.dataset.originalValue||e.value;var r;if(r=document.getElementById("status_po_number"),r&&(r.textContent=n),r=document.getElementById("status_from"),r&&(r.textContent=l),r=document.getElementById("status_to"),r&&(r.textContent=d),r=document.getElementById("status_remarks"),r&&(r.value=""),window.bootstrap&&document.getElementById("statusChangeModal")){var i=new bootstrap.Modal(document.getElementById("statusChangeModal"));i.show()}e.value=e.dataset.originalValue}})});function E(o){var t=o.options[o.selectedIndex].textContent,e=o.closest(".d-flex")?.querySelector(".status-indicator");if(e)switch(e.classList.remove("status-warning","status-info","status-online","status-success","status-offline"),t){case"Pending":e.classList.add("status-warning");break;case"Verified":e.classList.add("status-info");break;case"Approved":e.classList.add("status-online");break;case"Received":e.classList.add("status-success");break;case"Rejected":e.classList.add("status-offline");break}}var p=document.getElementById("confirmStatusChange");p&&p.addEventListener("click",function(){var o=document.getElementById("statusChangeForm"),t=document.getElementById("selected_status_id"),e=document.getElementById("status_remarks");if(!o||!t||!t.value){console.error("[PO Status Update] Missing form or status ID");return}var a=t.value,n=e?e.value:"",l=o.querySelector('input[name="_token"]'),d=l?l.value:"",s=new FormData(o);s.set("status_id",a),s.set("remarks",n||"Status changed via status modal"),console.log("[PO Status Update] Sending request...",{action:o.action,status_id:a,remarks:n}),p&&(p.disabled=!0),fetch(o.action,{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":d},body:s,credentials:"same-origin"}).then(async function(r){const i=r.headers.get("content-type");if(!i||!i.includes("application/json")){const c=await r.text();throw console.error("[PO Status Update] Received non-JSON response:",c.substring(0,200)),new Error("Server returned HTML instead of JSON. Please check authentication.")}const u=await r.json();if(!r.ok)throw new Error(u.error||"Failed to update status");return u}).then(function(r){console.log("[PO Status Update] Success:",r),r.success&&r.message&&_(r.message,"success"),setTimeout(function(){location.reload()},1500)}).catch(function(r){console.error("[PO Status Update] Error:",r),_("Error: "+r.message,"error")}).finally(function(){p&&(p.disabled=!1);var r=bootstrap.Modal.getInstance(document.getElementById("statusChangeModal"));r&&r.hide()})});function C(o){var t=o&&o.po||{},e=o&&o.items||[],a;a=document.getElementById("edit-po-number"),a&&(a.value=t.purchase_order_no||""),a=document.getElementById("purpose-input"),a&&(a.value=t.purpose||""),a=document.getElementById("date-from"),a&&(a.value=t.date_requested||""),a=document.getElementById("date-to"),a&&(a.value=t.delivery_date||"");var n=document.getElementById("supplier-select");n&&t.supplier_id&&(n.value=t.supplier_id,n.dispatchEvent(new Event("change"))),window.jQuery&&typeof window.updatePODateInfo=="function"&&(console.log("Triggering datepicker date info update after data population"),setTimeout(function(){window.updatePODateInfo()},100)),console.log("PO edit modal populated with data:",{po_number:t.purchase_order_no,date_requested:t.date_requested,delivery_date:t.delivery_date,supplier_id:t.supplier_id}),a=document.getElementById("calc-shipping-input"),a&&(a.value=Number(t.shipping_fee||0).toFixed(2)),a=document.getElementById("calc-discount-input"),a&&(a.value=Number(t.discount||0).toFixed(2)),a=document.getElementById("calc-subtotal"),a&&(a.value=Number(t.subtotal||0).toFixed(2)),a=document.getElementById("calc-vat"),a&&(a.value=Number((t.total||0)-(t.subtotal||0)).toFixed(2)),a=document.getElementById("calc-total"),a&&(a.textContent=Number(t.total||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}));var l=document.getElementById("items");l&&(l.innerHTML="",e.forEach(function(d,s){var r=document.getElementById("itemRowTpl");if(r){var i=r.innerHTML.replaceAll("IDX",String(s)),u=document.createElement("div");u.innerHTML=i;var c=u.firstElementChild;l.appendChild(c);var g=c.querySelector(".item-name-select"),y=c.querySelector(".item-name-manual"),w=c.querySelector(".item-desc-manual"),b=c.querySelector('input[name$="[quantity]"]'),h=c.querySelector(".unit-price");if(g&&d.item_name){var I=!1;Array.from(g.options).forEach(function(B){B.value===d.item_name&&(B.selected=!0,I=!0)}),I||(g.value="__manual__",g.dispatchEvent(new Event("change")),y&&(y.value=d.item_name))}w&&(w.value=d.item_description||""),b&&(b.value=d.quantity||""),h&&(h.value=Number(d.unit_price||0).toFixed(2)),window.poEditWireRow&&window.poEditWireRow(c)}}),window.poEditRecalcTotals&&window.poEditRecalcTotals())}window.showEditModal=function(o){try{window.poEditClearDraft&&window.poEditClearDraft();var t=document.getElementById("po-index-table"),e=t?t.getAttribute("data-po-show-template"):null,a=e?e.replace("__po__",o):"/po/"+o+"/data";fetch(a).then(n=>n.json()).then(n=>{C(n);var l=document.getElementById("poEditForm");l&&(l.action="/po/"+o);var d=new bootstrap.Modal(document.getElementById("editPOModal"));document.getElementById("editPOModal").addEventListener("shown.bs.modal",function s(){console.log("Edit modal shown via showEditModal - datepickers should initialize"),document.getElementById("editPOModal").removeEventListener("shown.bs.modal",s)},{once:!0}),d.show()}).catch(n=>{console.error("Error loading PO data:",n),alert("Error loading purchase order data")})}catch(n){console.error(n),alert("Could not open edit modal.")}};var S=document.querySelectorAll(".alert");S.forEach(function(o){setTimeout(function(){var t=new bootstrap.Alert(o);t.close()},5e3)});function _(o,t){const e=t==="success"?"alert-success":"alert-danger",a=t==="success"?"fa-check-circle":"fa-exclamation-circle",n=document.createElement("div");n.className=`alert ${e} alert-dismissible fade show position-fixed`,n.style.cssText="top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);",n.innerHTML=`
      <i class="fas ${a} me-2"></i>${o}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `,document.body.appendChild(n),setTimeout(function(){n.parentNode&&new bootstrap.Alert(n).close()},3e3)}async function L(o){try{const t=await fetch(`/api/purchase-orders/${o}`);if(!t.ok){const a=await t.json();throw new Error(a.message||`HTTP error! status: ${t.status}`)}const e=await t.json();if(e.success){document.getElementById("order_po_number").textContent=e.order.purchase_order_no||"",document.getElementById("order_made_by").textContent=e.order.made_by||"N/A",document.getElementById("order_date_requested").textContent=e.order.date_requested||"N/A",document.getElementById("order_delivery_date").textContent=e.order.delivery_date||"N/A";const a=i=>{if(!i)return"N/A";try{return new Date(i).toLocaleString()}catch{return i}};document.getElementById("order_created_at").textContent=a(e.order.created_at),document.getElementById("order_updated_at").textContent=a(e.order.updated_at),document.getElementById("order_purpose").textContent=e.order.purpose||"N/A",document.getElementById("order_supplier").textContent=e.order.supplier_name||"N/A";const n=document.getElementById("order_status");n.textContent=e.order.status_name||"N/A",n.className="badge bg-secondary";const l=e.order.status_name;if(l)switch(n.classList.remove("bg-secondary"),l.toLowerCase()){case"pending":n.classList.add("bg-warning");break;case"verified":n.classList.add("bg-info");break;case"approved":n.classList.add("bg-success");break;case"received":n.classList.add("bg-primary");break;case"rejected":n.classList.add("bg-danger");break;default:n.classList.add("bg-secondary")}document.getElementById("order_remarks").textContent=e.order.remarks||"No remarks";const d=i=>`â‚±${Number(i||0).toLocaleString("en-PH",{minimumFractionDigits:2,maximumFractionDigits:2})}`;document.getElementById("order_subtotal").textContent=d(e.order.subtotal),document.getElementById("order_shipping").textContent=d(e.order.shipping_fee),document.getElementById("order_discount").textContent=d(e.order.discount),document.getElementById("order_total").textContent=d(e.order.total);const s=document.getElementById("order_items");s.innerHTML="",(e.items||[]).forEach(i=>{const u=Number(i.quantity||0),c=Number(i.unit_price||0),g=Number(i.total_cost||u*c),y=`<tr>
              <td>${i.item_name||"N/A"}</td>
              <td>${i.description||"N/A"}</td>
              <td class="text-end">${u}</td>
              <td class="text-end">${d(c)}</td>
              <td class="text-end">${d(g)}</td>
          </tr>`;s.insertAdjacentHTML("beforeend",y)}),new bootstrap.Modal(document.getElementById("orderDetailsModal")).show()}else alert("Failed to fetch order details. Please try again.")}catch(t){console.error("Error fetching order details:",t),console.error("Error details:",{message:t.message,stack:t.stack,poNumber:o}),alert(`Error fetching order details: ${t.message}. Please check the console for more details.`)}}});let x="";window.showStatusChangeModal=function(m,f){x=f,document.getElementById("status_po_number").textContent=m,document.getElementById("status_current").textContent=f,document.getElementById("statusChangeForm").action=`/po/${m}/status`,document.getElementById("selected_status_id").value="",document.getElementById("status_remarks").value="",document.getElementById("confirmStatusChange").disabled=!0,document.querySelectorAll(".status-option").forEach(v=>{v.classList.remove("active")}),new bootstrap.Modal(document.getElementById("statusChangeModal")).show()};window.selectStatus=function(m){document.querySelectorAll(".status-option").forEach(p=>{p.classList.remove("active")}),m.classList.add("active");const f=m.getAttribute("data-status-id"),v=m.getAttribute("data-status-name");document.getElementById("selected_status_id").value=f;const E=document.getElementById("confirmStatusChange");v!==x?E.disabled=!1:E.disabled=!0};
