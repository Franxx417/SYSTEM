document.addEventListener("DOMContentLoaded",function(){var l=document.getElementById("po-index-table");if(!l)return;var p=l.getAttribute("data-po-show-template");if(!p)return;l.addEventListener("click",async function(o){var e=o.target&&o.target.closest(".btn-view-po");if(e){var n=e.getAttribute("data-po"),t=p.replace("__po__",n);try{var a=await fetch(t);if(!a.ok)return;var d=await a.json();x(d),window.bootstrap&&document.getElementById("poModal")&&new bootstrap.Modal(document.getElementById("poModal")).show()}catch{}}}),window.editPO=function(e,n,t,a,d){var r=document.getElementById("editPOForm");r&&(r.action="/po/"+e);var s;s=document.getElementById("edit_purpose"),s&&(s.value=n||""),s=document.getElementById("edit_supplier_id"),s&&(s.value=t||""),s=document.getElementById("edit_date_requested"),s&&(s.value=a||""),s=document.getElementById("edit_delivery_date"),s&&(s.value=d||""),window.bootstrap&&document.getElementById("editPOModal")&&new bootstrap.Modal(document.getElementById("editPOModal")).show()},window.deletePO=function(e,n){var t=document.getElementById("deletePOForm");t&&(t.action="/po/"+e);var a;a=document.getElementById("delete_po_number"),a&&(a.textContent=e||""),a=document.getElementById("delete_po_purpose"),a&&(a.textContent=n||""),window.bootstrap&&document.getElementById("deletePOModal")&&new bootstrap.Modal(document.getElementById("deletePOModal")).show()};var g=document.querySelectorAll(".status-dropdown");g.forEach(function(o){o.dataset.originalValue=o.value,v(o),o.addEventListener("change",function(e){e.preventDefault(),e.stopPropagation();var n=this,t=n.closest("form");if(t){t.addEventListener("submit",function(u){window.__allowStatusSubmit||(u.preventDefault(),u.stopPropagation())},{once:!0,capture:!0});var a=n.dataset.po||t.action.split("/").pop(),d=n.getAttribute("data-current-status")||(function(){var u=n.options[n.selectedIndex];return u?u.textContent:""})(),r=n.options[n.selectedIndex].textContent,s=n.value;window.pendingStatusForm=t,window.pendingStatusValue=s,window.pendingStatusSelect=n,window.pendingStatusOldValue=n.dataset.originalValue||n.value;var i;if(i=document.getElementById("status_po_number"),i&&(i.textContent=a),i=document.getElementById("status_from"),i&&(i.textContent=d),i=document.getElementById("status_to"),i&&(i.textContent=r),i=document.getElementById("status_remarks"),i&&(i.value=""),window.bootstrap&&document.getElementById("statusChangeModal")){var f=new bootstrap.Modal(document.getElementById("statusChangeModal"));f.show()}n.value=n.dataset.originalValue}})});function v(o){var e=o.options[o.selectedIndex].textContent,n=o.closest(".d-flex")?.querySelector(".status-indicator");if(n)switch(n.classList.remove("status-warning","status-info","status-online","status-success","status-offline"),e){case"Pending":n.classList.add("status-warning");break;case"Verified":n.classList.add("status-info");break;case"Approved":n.classList.add("status-online");break;case"Received":n.classList.add("status-success");break;case"Rejected":n.classList.add("status-offline");break}}var m=document.getElementById("confirmStatusChange");m&&m.addEventListener("click",function(){var o=document.getElementById("statusChangeForm"),e=document.getElementById("selected_status_id"),n=document.getElementById("status_remarks");if(!o||!e||!e.value){console.error("[PO Status Update] Missing form or status ID");return}var t=e.value,a=n?n.value:"",d=o.querySelector('input[name="_token"]'),r=d?d.value:"",s=new FormData(o);s.set("status_id",t),s.set("remarks",a||"Status changed via status modal"),console.log("[PO Status Update] Sending request...",{action:o.action,status_id:t,remarks:a}),m&&(m.disabled=!0),fetch(o.action,{method:"POST",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":r},body:s,credentials:"same-origin"}).then(async function(i){const f=i.headers.get("content-type");if(!f||!f.includes("application/json")){const c=await i.text();throw console.error("[PO Status Update] Received non-JSON response:",c.substring(0,200)),new Error("Server returned HTML instead of JSON. Please check authentication.")}const u=await i.json();if(!i.ok)throw new Error(u.error||"Failed to update status");return u}).then(function(i){console.log("[PO Status Update] Success:",i),i.success&&i.message&&y(i.message,"success"),setTimeout(function(){location.reload()},1500)}).catch(function(i){console.error("[PO Status Update] Error:",i),y("Error: "+i.message,"error")}).finally(function(){m&&(m.disabled=!1);var i=bootstrap.Modal.getInstance(document.getElementById("statusChangeModal"));i&&i.hide()})});function x(o){var e=o&&o.po||{},n=o&&o.items||[],t;t=document.getElementById("poModalLabel"),t&&(t.textContent="PO #"+(e.purchase_order_no||"")),t=document.getElementById("poModalSupplier"),t&&(t.textContent=e.supplier_name||""),t=document.getElementById("poModalStatus"),t&&(t.textContent=e.status_name||""),t=document.getElementById("poModalPurpose"),t&&(t.textContent=e.purpose||""),t=document.getElementById("poModalTotals"),t&&(t.textContent="₱"+Number(e.total||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}));var a=document.getElementById("poModalItems");a&&(a.innerHTML="",n.forEach(function(d){var r=document.createElement("tr");r.innerHTML="<td>"+(d.item_name||d.item_description||"")+'</td><td class="text-end">'+(d.quantity||0)+'</td><td class="text-end">₱'+Number(d.unit_price||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})+'</td><td class="text-end">₱'+Number(d.total_cost||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})+"</td>",a.appendChild(r)}))}function M(o){var e=o&&o.po||{},n=o&&o.items||[],t;t=document.getElementById("edit-po-number"),t&&(t.value=e.purchase_order_no||""),t=document.getElementById("purpose-input"),t&&(t.value=e.purpose||""),t=document.getElementById("date-from"),t&&(t.value=e.date_requested||""),t=document.getElementById("date-to"),t&&(t.value=e.delivery_date||"");var a=document.getElementById("supplier-select");a&&e.supplier_id&&(a.value=e.supplier_id,a.dispatchEvent(new Event("change"))),window.jQuery&&typeof window.updatePODateInfo=="function"&&(console.log("Triggering datepicker date info update after data population"),setTimeout(function(){window.updatePODateInfo()},100)),console.log("PO edit modal populated with data:",{po_number:e.purchase_order_no,date_requested:e.date_requested,delivery_date:e.delivery_date,supplier_id:e.supplier_id}),t=document.getElementById("calc-shipping-input"),t&&(t.value=Number(e.shipping_fee||0).toFixed(2)),t=document.getElementById("calc-discount-input"),t&&(t.value=Number(e.discount||0).toFixed(2)),t=document.getElementById("calc-subtotal"),t&&(t.value=Number(e.subtotal||0).toFixed(2)),t=document.getElementById("calc-vat"),t&&(t.value=Number((e.total||0)-(e.subtotal||0)).toFixed(2)),t=document.getElementById("calc-total"),t&&(t.textContent=Number(e.total||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}));var d=document.getElementById("items");d&&(d.innerHTML="",n.forEach(function(r,s){var i=document.getElementById("itemRowTpl");if(i){var f=i.innerHTML.replaceAll("IDX",String(s)),u=document.createElement("div");u.innerHTML=f;var c=u.firstElementChild;d.appendChild(c);var E=c.querySelector(".item-name-select"),w=c.querySelector(".item-name-manual"),h=c.querySelector(".item-desc-manual"),_=c.querySelector('input[name$="[quantity]"]'),b=c.querySelector(".unit-price");if(E&&r.item_name){var I=!1;Array.from(E.options).forEach(function(B){B.value===r.item_name&&(B.selected=!0,I=!0)}),I||(E.value="__manual__",E.dispatchEvent(new Event("change")),w&&(w.value=r.item_name))}h&&(h.value=r.item_description||""),_&&(_.value=r.quantity||""),b&&(b.value=Number(r.unit_price||0).toFixed(2)),window.poEditWireRow&&window.poEditWireRow(c)}}),window.poEditRecalcTotals&&window.poEditRecalcTotals())}window.showEditModal=function(o){try{window.poEditClearDraft&&window.poEditClearDraft();var e=document.getElementById("po-index-table"),n=e?e.getAttribute("data-po-show-template"):null,t=n?n.replace("__po__",o):"/po/"+o+"/data";fetch(t).then(a=>a.json()).then(a=>{M(a);var d=document.getElementById("poEditForm");d&&(d.action="/po/"+o);var r=new bootstrap.Modal(document.getElementById("editPOModal"));document.getElementById("editPOModal").addEventListener("shown.bs.modal",function s(){console.log("Edit modal shown via showEditModal - datepickers should initialize"),document.getElementById("editPOModal").removeEventListener("shown.bs.modal",s)},{once:!0}),r.show()}).catch(a=>{console.error("Error loading PO data:",a),alert("Error loading purchase order data")})}catch(a){console.error(a),alert("Could not open edit modal.")}};var C=document.querySelectorAll(".alert");C.forEach(function(o){setTimeout(function(){var e=new bootstrap.Alert(o);e.close()},5e3)});function y(o,e){const n=e==="success"?"alert-success":"alert-danger",t=e==="success"?"fa-check-circle":"fa-exclamation-circle",a=document.createElement("div");a.className=`alert ${n} alert-dismissible fade show position-fixed`,a.style.cssText="top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);",a.innerHTML=`
      <i class="fas ${t} me-2"></i>${o}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `,document.body.appendChild(a),setTimeout(function(){a.parentNode&&new bootstrap.Alert(a).close()},3e3)}});let S="";window.showStatusChangeModal=function(l,p){S=p,document.getElementById("status_po_number").textContent=l,document.getElementById("status_current").textContent=p,document.getElementById("statusChangeForm").action=`/po/${l}/status`,document.getElementById("selected_status_id").value="",document.getElementById("status_remarks").value="",document.getElementById("confirmStatusChange").disabled=!0,document.querySelectorAll(".status-option").forEach(g=>{g.classList.remove("active")}),new bootstrap.Modal(document.getElementById("statusChangeModal")).show()};window.selectStatus=function(l){document.querySelectorAll(".status-option").forEach(m=>{m.classList.remove("active")}),l.classList.add("active");const p=l.getAttribute("data-status-id"),g=l.getAttribute("data-status-name");document.getElementById("selected_status_id").value=p;const v=document.getElementById("confirmStatusChange");g!==S?v.disabled=!1:v.disabled=!0};
