document.addEventListener("DOMContentLoaded",()=>{console.log("PO Create script loaded");const r=document.getElementById("poForm");if(!r){console.log("Form element not found");return}console.log("Form element found:",r);const v=document.getElementById("items"),g=document.getElementById("itemRowTpl"),S=g?g.innerHTML:"";let E=0;fetch(r.dataset.nextNumberUrl||"/po/next/number").then(t=>t.ok?t.json():{}).then(t=>{const e=document.getElementById("po-number");e&&t.po_no&&(e.value=t.po_no)}).catch(()=>{});const l=document.getElementById("supplier-select"),_=document.getElementById("manual-supplier-fields");function B(){const t=l?.options[l.selectedIndex],e=document.getElementById("supplier-vat"),a=t&&t.dataset&&t.dataset.vat?t.dataset.vat:"";if(e&&(e.textContent=a||"—"),l&&l.value==="__manual__"){_&&_.classList.remove("d-none");const n=document.getElementById("supplier-vat-type")?.value||"";e&&(e.textContent=n||"—"),[["supplier-name","new_supplier[name]"],["supplier-vat-type","new_supplier[vat_type]"],["supplier-address","new_supplier[address]"],["supplier-contact-person","new_supplier[contact_person]"],["supplier-contact-number","new_supplier[contact_number]"],["supplier-tin","new_supplier[tin_no]"]].forEach(([o,u])=>{const p=document.getElementById(o);p&&p.setAttribute("name",u)})}else _&&_.classList.add("d-none"),["supplier-name","supplier-vat-type","supplier-address","supplier-contact-person","supplier-contact-number","supplier-tin"].forEach(n=>{const i=document.getElementById(n);i&&i.removeAttribute("name")})}l&&(l.addEventListener("change",()=>{B(),s()}),B());const b=document.getElementById("supplier-vat-type");b&&b.addEventListener("change",function(){if(l&&l.value==="__manual__"){const t=document.getElementById("supplier-vat");t&&(t.textContent=this.value)}s()});function w(){const t=S.replaceAll("IDX",String(E++)),e=document.createElement("div");e.innerHTML=t;const a=e.firstElementChild;v&&v.appendChild(a),m(a),s()}const c=document.getElementById("addItem");c&&c.addEventListener("click",w),v&&v.addEventListener("click",t=>{const e=t.target;if(e&&e.classList&&e.classList.contains("removeItem")){const a=e.closest(".item-row");a&&a.remove(),s()}}),r&&r.addEventListener("submit",t=>{console.log("Form submit event triggered");const e=Array.from(document.querySelectorAll(".item-row"));console.log("Found rows:",e.length),e.length&&e.forEach((a,n)=>{const i=a.querySelector(".item-name-select"),o=a.querySelector(".item-name-manual"),u=a.querySelector(".item-desc-manual"),p=a.querySelector('input[name$="[quantity]"]'),d=a.querySelector(".unit-price");u&&(u.name=`items[${n}][item_description]`),p&&(p.name=`items[${n}][quantity]`),d&&(d.name=`items[${n}][unit_price]`);const f=o&&!o.classList.contains("d-none");console.log(`Row ${n}: manualVisible=${f}, nameSelect.value=${i?.value}, nameManual.value=${o?.value}`),f?(i&&i.removeAttribute("name"),o&&(o.name=`items[${n}][item_name]`),console.log(`Row ${n}: Set manual name to items[${n}][item_name]`)):(o&&o.removeAttribute("name"),i&&(i.name=`items[${n}][item_name]`),console.log(`Row ${n}: Set select name to items[${n}][item_name]`))})},!0);function m(t){const e=t.querySelector(".item-name-select"),a=t.querySelector(".item-desc-manual"),n=t.querySelector(".unit-price"),i=t.querySelector(".item-name-manual");function o(){i&&(i.classList.remove("d-none"),i.name=e.name,i.focus()),e&&e.removeAttribute("name")}function u(){e&&!e.name&&(e.name=i&&i.name?i.name:"items[][item_name]"),i&&(i.name="",i.classList.add("d-none"))}e&&e.addEventListener("change",async()=>{if(!e.value){u(),a&&(a.value=""),n&&(n.value=""),s();return}if(e.value==="__manual__"){o(),a&&(a.value=""),n&&(n.value=""),s();return}u();const d=e.options[e.selectedIndex],f=d&&d.dataset?d.dataset.desc:"",y=d&&d.dataset?d.dataset.price:"";a&&(a.value=f||""),n&&y?n.value=parseFloat(y).toFixed(2):n&&(n.value=""),s()});const p=t.querySelector('input[name$="[quantity]"]');p&&p.addEventListener("input",s),n&&n.addEventListener("input",s)}function s(){let t=0;document.querySelectorAll(".item-row").forEach(I=>{const $=I.querySelector('input[name$="[quantity]"]'),M=I.querySelector(".unit-price"),N=parseFloat($&&$.value||"0"),V=parseFloat(M&&M.value||"0");t+=N*V});const e=document.getElementById("calc-shipping-input"),a=document.getElementById("calc-discount-input"),n=e&&parseFloat((e.value||"0").replace(/[^0-9.]/g,""))||0,i=a&&parseFloat((a.value||"0").replace(/[^0-9.]/g,""))||0,o=Math.max(0,Math.round((t-i+n)*100)/100);let u="";if(l)if(l.value==="__manual__")u=document.getElementById("supplier-vat-type")?.value||"";else{const I=l.options[l.selectedIndex];u=I&&I.dataset&&I.dataset.vat?I.dataset.vat:""}let p=0;u&&u.toUpperCase()==="VAT"?p=Math.round(o*.12*100)/100:p=0;const d=Math.round((o+(u?p:0))*100)/100,f=document.getElementById("calc-subtotal"),y=document.getElementById("calc-vat"),D=document.getElementById("calc-total");u?(f&&(f.value=o.toFixed(2)),y&&(y.value=p.toFixed(2))):(f&&(f.value="0"),y&&(y.value="0")),D&&(D.textContent=d.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))}const h=document.getElementById("calc-shipping-input"),L=document.getElementById("calc-discount-input");h&&h.addEventListener("input",s),L&&L.addEventListener("input",s),S&&v&&(w(),s());const q="po_create_draft_v1";function x(){const t={supplier_id:l?l.value:"",new_supplier:{name:document.getElementById("supplier-name")?.value||"",vat_type:document.getElementById("supplier-vat-type")?.value||"",address:document.getElementById("supplier-address")?.value||"",contact_person:document.getElementById("supplier-contact-person")?.value||"",contact_number:document.getElementById("supplier-contact-number")?.value||"",tin_no:document.getElementById("supplier-tin")?.value||""},purpose:document.getElementById("purpose-input")?.value||"",date_requested:document.getElementById("date-from")?.value||"",delivery_date:document.getElementById("date-to")?.value||"",items:[]};return document.querySelectorAll("#items .item-row").forEach(e=>{const a=e.querySelector(".item-name-select"),n=e.querySelector(".item-name-manual"),o=n&&!n.classList.contains("d-none")?n.value||"":a?a.value:"";t.items.push({item_name:o,item_description:e.querySelector(".item-desc-manual")?.value||"",quantity:e.querySelector('input[name$="[quantity]"]')?.value||"",unit_price:e.querySelector(".unit-price")?.value||""})}),t}function T(t){try{if(!t)return;l&&t.supplier_id&&(l.value=t.supplier_id,l.dispatchEvent(new Event("change")));const e=t.new_supplier||{},a=(n,i)=>{const o=document.getElementById(n);o&&(o.value=i||"",o.dispatchEvent(new Event("input")))};a("supplier-name",e.name),a("supplier-vat-type",e.vat_type),a("supplier-address",e.address),a("supplier-contact-person",e.contact_person),a("supplier-contact-number",e.contact_number),a("supplier-tin",e.tin_no),a("purpose-input",t.purpose),a("date-from",t.date_requested),a("date-to",t.delivery_date),v&&(v.innerHTML="",E=0),(t.items||[]).forEach(n=>{w();const i=v.lastElementChild,o=i.querySelector(".item-name-select"),u=i.querySelector(".item-name-manual");o&&(n.item_name==="__manual__"||u&&n.item_name&&!Array.from(o.options).some(y=>y.value===n.item_name)?(o.value="__manual__",o.dispatchEvent(new Event("change")),u&&(u.value=n.item_name)):(o.value=n.item_name||"",o.dispatchEvent(new Event("change"))));const p=i.querySelector(".item-desc-manual");p&&(p.value=n.item_description||"",p.dispatchEvent(new Event("input")));const d=i.querySelector('input[name$="[quantity]"]');d&&(d.value=n.quantity||"",d.dispatchEvent(new Event("input")));const f=i.querySelector(".unit-price");f&&(f.value=n.unit_price||"",f.dispatchEvent(new Event("input")))}),s()}catch{}}function F(){try{localStorage.setItem(q,JSON.stringify(x()))}catch{}}function A(){try{const t=localStorage.getItem(q);return t?JSON.parse(t):null}catch{return null}}function C(){try{localStorage.removeItem(q)}catch{}}r.addEventListener("input",F),r.addEventListener("change",F),T(A()),r.addEventListener("submit",()=>{C()})});typeof window<"u"&&window.jQuery&&jQuery(function(r){const v=r("#date-from"),g=r("#date-to");v.length&&g.length&&(v.datepicker({dateFormat:"yy-mm-dd",onSelect:c=>{g.datepicker("option","minDate",c),S()}}),g.datepicker({dateFormat:"yy-mm-dd",onSelect:c=>{v.datepicker("option","maxDate",c),S()}}));function S(){const c=v.val(),m=g.val(),s=r("#result");if(c&&m){const h=new Date(c),L=new Date(m),q=Math.abs(L-h),x=Math.ceil(q/(1e3*60*60*24));s.text(`Delivery period: ${x} days`)}else s.text("")}const E=r("#purpose-input"),l=r("#text-count"),_=E.attr("maxlength");if(E.length&&l.length&&_){let c=function(){const m=_-E.val().length;l.text(m+" characters remaining"),l.toggleClass("text-danger",m<=20).toggleClass("text-muted",m>20)};var w=c;c(),E.on("input",c)}function B(){const c=r(this);let m=c.val().replace(/[^0-9.]/g,"");const s=m.split(".");s.length>2&&(m=s[0]+"."+s.slice(1).join(""));const h=parseFloat(m);(h<0||isNaN(h))&&(m="0.00"),c.val(m)}function b(){const c=r(this),m=parseFloat(c.val());c.val(isNaN(m)?"0.00":m.toFixed(2))}r("#calc-shipping-input, #calc-discount-input").on("input",B).on("blur",b)});
