document.addEventListener("DOMContentLoaded",function(){u(),f(),p(),g()});function u(){const t=document.getElementById("preferencesForm");t&&t.addEventListener("submit",async function(o){o.preventDefault();const e=this.querySelector('button[type="submit"]'),s=e.innerHTML;e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin me-1"></i>Saving...';try{const n=new FormData(this),r={language:n.get("language")||document.querySelector('select[name="language"]').value,date_format:n.get("date_format")||document.querySelector('select[name="date_format"]').value,time_format:n.get("time_format")||document.querySelector('select[name="time_format"]').value,timezone:n.get("timezone")||document.querySelector('select[name="timezone"]').value,auto_save:document.getElementById("autoSave").checked,compact_view:document.getElementById("compactView").checked},m=await(await fetch("/settings/preferences",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,Accept:"application/json"},body:JSON.stringify(r)})).json();if(m.success)l("Success",m.message,"success");else throw new Error(m.message||"Failed to save preferences")}catch(n){console.error("Error saving preferences:",n),l("Error",n.message||"Failed to save preferences","danger")}finally{e.disabled=!1,e.innerHTML=s}})}function f(){const t=document.getElementById("notificationsForm");t&&t.addEventListener("submit",async function(o){o.preventDefault();const e=this.querySelector('button[type="submit"]'),s=e.innerHTML;e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin me-1"></i>Saving...';try{const n={notif_po_created:document.getElementById("notif_po_created").checked,notif_po_approved:document.getElementById("notif_po_approved").checked,notif_po_rejected:document.getElementById("notif_po_rejected").checked,notif_system_updates:document.getElementById("notif_system_updates").checked,notif_security:document.getElementById("notif_security").checked,email_daily_summary:document.getElementById("email_daily_summary").checked,email_weekly_report:document.getElementById("email_weekly_report").checked},i=await(await fetch("/settings/notifications",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,Accept:"application/json"},body:JSON.stringify(n)})).json();if(i.success)l("Success",i.message,"success");else throw new Error(i.message||"Failed to save notification settings")}catch(n){console.error("Error saving notifications:",n),l("Error",n.message||"Failed to save notification settings","danger")}finally{e.disabled=!1,e.innerHTML=s}})}async function p(){try{const o=await(await fetch("/settings/preferences",{method:"GET",headers:{Accept:"application/json"}})).json();if(o.success&&o.preferences){const e=o.preferences,s=document.querySelector('select[name="language"]'),n=document.querySelector('select[name="date_format"]'),r=document.querySelector('select[name="time_format"]'),i=document.querySelector('select[name="timezone"]');if(s){const c=Array.from(s.options).find(a=>a.value===e.language||a.textContent.includes(h(e.language)));c&&(c.selected=!0)}if(n){const c=Array.from(n.options).find(a=>a.value===e.date_format);c&&(c.selected=!0)}if(r){const c=Array.from(r.options).find(a=>a.value===e.time_format||a.textContent.includes(e.time_format+"-hour"));c&&(c.selected=!0)}if(i){const c=Array.from(i.options).find(a=>a.value===e.timezone||a.textContent.includes(e.timezone));c&&(c.selected=!0)}const m=document.getElementById("autoSave"),d=document.getElementById("compactView");m&&(m.checked=e.auto_save),d&&(d.checked=e.compact_view)}}catch(t){console.error("Error loading preferences:",t)}}async function g(){try{const o=await(await fetch("/settings/notifications",{method:"GET",headers:{Accept:"application/json"}})).json();if(o.success&&o.notifications){const e=o.notifications;Object.keys(e).forEach(s=>{const n=document.getElementById(s);n&&(n.checked=e[s])})}}catch(t){console.error("Error loading notifications:",t)}}function l(t,o,e="info"){const s=document.querySelector(".toast-container")||y(),n=`
        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-${e} text-white">
                <i class="fas fa-${e==="success"?"check":"exclamation"}-circle me-2"></i>
                <strong class="me-auto">${t}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${o}
            </div>
        </div>
    `;s.insertAdjacentHTML("beforeend",n);const r=s.lastElementChild,i=new bootstrap.Toast(r);setTimeout(()=>{i.hide(),setTimeout(()=>r.remove(),500)},5e3)}function y(){const t=document.createElement("div");return t.className="toast-container position-fixed top-0 end-0 p-3",t.style.zIndex="11",document.body.appendChild(t),t}function h(t){return{en:"English",fil:"Filipino",zh:"中文"}[t]||t}document.addEventListener("DOMContentLoaded",function(){const t=document.getElementById("preferencesForm");if(t){const o=t.querySelector("select:nth-of-type(1)"),e=t.querySelector("select:nth-of-type(2)"),s=t.querySelector("select:nth-of-type(3)"),n=t.querySelector("select:nth-of-type(4)");o&&!o.name&&(o.name="language"),e&&!e.name&&(e.name="date_format"),s&&!s.name&&(s.name="time_format"),n&&!n.name&&(n.name="timezone")}});
