document.addEventListener("DOMContentLoaded",function(){console.log("PO Edit script loaded");var d=document.getElementById("poEditForm");if(!d){console.log("Form element not found");return}console.log("Form element found:",d);var u=document.getElementById("items"),y=document.getElementById("itemRowTpl"),S=y?y.innerHTML:"",I=u&&u.children?u.children.length:0;const c=document.getElementById("supplier-select"),E=document.getElementById("manual-supplier-fields");function w(){const n=c?.options[c.selectedIndex],e=document.getElementById("supplier-vat"),a=n&&n.dataset&&n.dataset.vat?n.dataset.vat:"";if(e&&(e.textContent=a||"—"),c&&c.value==="__manual__"){E&&E.classList.remove("d-none");const t=document.getElementById("supplier-vat-type")?.value||"";e&&(e.textContent=t||"—"),[["supplier-name","new_supplier[name]"],["supplier-vat-type","new_supplier[vat_type]"],["supplier-address","new_supplier[address]"],["supplier-contact-person","new_supplier[contact_person]"],["supplier-contact-number","new_supplier[contact_number]"],["supplier-tin","new_supplier[tin_no]"]].forEach(([r,m])=>{const p=document.getElementById(r);p&&p.setAttribute("name",m)})}else E&&E.classList.add("d-none"),["supplier-name","supplier-vat-type","supplier-address","supplier-contact-person","supplier-contact-number","supplier-tin"].forEach(t=>{const i=document.getElementById(t);i&&i.removeAttribute("name")})}c&&(c.addEventListener("change",()=>{w(),l()}),w());const x=document.getElementById("supplier-vat-type");x&&x.addEventListener("change",function(){if(c&&c.value==="__manual__"){const n=document.getElementById("supplier-vat");n&&(n.textContent=this.value)}l()});function B(){const n=S.replaceAll("IDX",String(I++)),e=document.createElement("div");e.innerHTML=n;const a=e.firstElementChild;u&&u.appendChild(a),v(a),l()}var o=document.getElementById("addItem");o&&o.addEventListener("click",B),u&&u.addEventListener("click",function(n){var e=n.target;if(e&&e.classList&&e.classList.contains("removeItem")){var a=e.closest(".item-row");a&&a.remove(),l()}}),d&&d.addEventListener("submit",n=>{console.log("Form submit event triggered");const e=Array.from(document.querySelectorAll(".item-row"));console.log("Found rows:",e.length),e.length&&e.forEach((a,t)=>{const i=a.querySelector(".item-name-select"),r=a.querySelector(".item-name-manual"),m=a.querySelector(".item-desc-manual"),p=a.querySelector('input[name$="[quantity]"]'),f=a.querySelector(".unit-price");m&&(m.name=`items[${t}][item_description]`),p&&(p.name=`items[${t}][quantity]`),f&&(f.name=`items[${t}][unit_price]`);const g=r&&!r.classList.contains("d-none");console.log(`Row ${t}: manualVisible=${g}, nameSelect.value=${i?.value}, nameManual.value=${r?.value}`),g?(i&&i.removeAttribute("name"),r&&(r.name=`items[${t}][item_name]`),console.log(`Row ${t}: Set manual name to items[${t}][item_name]`)):(r&&r.removeAttribute("name"),i&&(i.name=`items[${t}][item_name]`),console.log(`Row ${t}: Set select name to items[${t}][item_name]`))})},!0);function s(){u&&Array.prototype.forEach.call(u.querySelectorAll(".item-row"),v)}function v(n){const e=n.querySelector(".item-name-select"),a=n.querySelector(".item-desc-manual"),t=n.querySelector(".unit-price"),i=n.querySelector(".item-name-manual");function r(){i&&(i.classList.remove("d-none"),i.name=e.name,i.focus()),e&&e.removeAttribute("name")}function m(){e&&!e.name&&(e.name=i&&i.name?i.name:"items[][item_name]"),i&&(i.name="",i.classList.add("d-none"))}e&&e.addEventListener("change",async()=>{if(!e.value){m(),a&&(a.value=""),t&&(t.value=""),l();return}if(e.value==="__manual__"){r(),a&&(a.value=""),t&&(t.value=""),l();return}m();const f=e.options[e.selectedIndex],g=f&&f.dataset?f.dataset.desc:"",h=f&&f.dataset?f.dataset.price:"";a&&(a.value=g||""),t&&h?t.value=parseFloat(h).toFixed(2):t&&(t.value=""),l()});const p=n.querySelector('input[name$="[quantity]"]');p&&p.addEventListener("input",l),t&&t.addEventListener("input",l)}function l(){let n=0;document.querySelectorAll(".item-row").forEach(_=>{const b=_.querySelector('input[name$="[quantity]"]'),$=_.querySelector(".unit-price"),D=parseFloat(b&&b.value||"0"),M=parseFloat($&&$.value||"0");n+=D*M});const e=document.getElementById("calc-shipping-input"),a=document.getElementById("calc-discount-input"),t=e&&parseFloat((e.value||"0").replace(/[^0-9.]/g,""))||0,i=a&&parseFloat((a.value||"0").replace(/[^0-9.]/g,""))||0,r=Math.max(0,Math.round((n-i+t)*100)/100);let m="";if(c)if(c.value==="__manual__")m=document.getElementById("supplier-vat-type")?.value||"";else{const _=c.options[c.selectedIndex];m=_&&_.dataset&&_.dataset.vat?_.dataset.vat:""}let p=0;m&&m.toUpperCase()==="VAT"?p=Math.round(r*.12*100)/100:p=0;const f=Math.round((r+(m?p:0))*100)/100,g=document.getElementById("calc-subtotal"),h=document.getElementById("calc-vat"),F=document.getElementById("calc-total");m?(g&&(g.value=r.toFixed(2)),h&&(h.value=p.toFixed(2))):(g&&(g.value="0"),h&&(h.value="0")),F&&(F.textContent=f.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))}const q=document.getElementById("calc-shipping-input"),L=document.getElementById("calc-discount-input");q&&q.addEventListener("input",l),L&&L.addEventListener("input",l),s(),S&&u&&l();try{window.poEditWireRow=v,window.poEditRecalcTotals=l}catch{}});typeof window<"u"&&window.jQuery&&jQuery(function(d){const u=d("#date-from"),y=d("#date-to");u.length&&y.length&&(u.datepicker({dateFormat:"yy-mm-dd",onSelect:o=>{y.datepicker("option","minDate",o),S()}}),y.datepicker({dateFormat:"yy-mm-dd",onSelect:o=>{u.datepicker("option","maxDate",o),S()}}));function S(){const o=u.val(),s=y.val(),v=d("#result");if(o&&s){const l=new Date(o),q=new Date(s),L=Math.abs(q-l),n=Math.ceil(L/(1e3*60*60*24));v.text(`Delivery period: ${n} days`)}else v.text("")}const I=d("#purpose-input"),c=d("#text-count"),E=I.attr("maxlength");if(I.length&&c.length&&E){let o=function(){const s=E-I.val().length;c.text(s+" characters remaining"),c.toggleClass("text-danger",s<=20).toggleClass("text-muted",s>20)};var B=o;o(),I.on("input",o)}function w(){const o=d(this);let s=o.val().replace(/[^0-9.]/g,"");const v=s.split(".");v.length>2&&(s=v[0]+"."+v.slice(1).join(""));const l=parseFloat(s);(l<0||isNaN(l))&&(s="0.00"),o.val(s)}function x(){const o=d(this),s=parseFloat(o.val());o.val(isNaN(s)?"0.00":s.toFixed(2))}d("#calc-shipping-input, #calc-discount-input").on("input",w).on("blur",x)});
